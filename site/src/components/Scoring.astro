---
// IgcScorer.astro
// Requires: npm install igc-xc-score igc-parser
---

<div class="flex flex-col gap-4 w-full">
  <div id="status" class="text-center text-sm text-gray-500">
    Provisional scoring tool
  </div>

  <label
    id="drop-zone"
    class="flex flex-col items-center justify-center gap-2 p-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
    </svg>
    <span class="text-sm text-gray-600">Drop an IGC file or click to browse</span>
    <input
      id="igc-input"
      type="file"
      accept=".igc,.IGC"
      class="hidden"
    />
  </label>

  <div id="status" class="text-center text-sm text-gray-500 hidden"></div>

  <div id="results" class="hidden rounded-lg border border-gray-200 bg-white p-4">
    <h3 class="font-semibold text-lg mb-3">Score Results</h3>
    <dl id="results-list" class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
    </dl>
  </div>

  <div id="upload-section" class="flex flex-col gap-3 pb-8" style="display:none">
    <div class="flex flex-col gap-1">
      <label for="user-id-input" class="text-sm font-medium text-gray-700">Your Name / ID</label>
      <input
        id="user-id-input"
        type="text"
        placeholder="e.g. john_doe"
        pattern="^[a-zA-Z0-9_-]{1,64}$"
        class="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
      />
      <span id="user-id-error" class="hidden text-xs text-red-600">Letters, numbers, hyphens, and underscores only (1–64 chars)</span>
    </div>
    <div class="flex flex-col gap-1">
      <label for="passphrase-input" class="text-sm font-medium text-gray-700">Passphrase</label>
      <input
        id="passphrase-input"
        type="password"
        placeholder="Enter your passphrase"
        class="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
      />
    </div>
    <button
      id="upload-btn"
      disabled
      class="self-start rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
    >
      Upload Tracklog
    </button>
    <div id="upload-status" class="hidden text-sm"></div>
  </div>
</div>

<script>
  import { score } from "../ts/hf_scoring.ts"

  const input = document.getElementById('igc-input') as HTMLInputElement;
  const dropZone = document.getElementById('drop-zone')!;
  const status = document.getElementById('status')!;
  const results = document.getElementById('results')!;
  const resultsList = document.getElementById('results-list')!;
  const uploadSection = document.getElementById('upload-section')!;
  const userIdInput = document.getElementById('user-id-input') as HTMLInputElement;
  const userIdError = document.getElementById('user-id-error')!;
  const passphraseInput = document.getElementById('passphrase-input') as HTMLInputElement;
  const uploadBtn = document.getElementById('upload-btn') as HTMLButtonElement;
  const uploadStatus = document.getElementById('upload-status')!;

  const USER_ID_RE = /^[a-zA-Z0-9_-]{1,64}$/;
  let currentFile: File | null = null;

  function updateUploadBtn() {
    const validId = USER_ID_RE.test(userIdInput.value);
    userIdError.classList.toggle('hidden', validId || userIdInput.value === '');
    uploadBtn.disabled = !(validId && passphraseInput.value.length > 0);
  }

  userIdInput.addEventListener('input', updateUploadBtn);
  passphraseInput.addEventListener('input', updateUploadBtn);

  function showStatus(msg: string, isError = false) {
    status.textContent = msg;
    status.classList.remove('hidden', 'text-red-600', 'text-gray-500');
    status.classList.add(isError ? 'text-red-600' : 'text-gray-500');
  }
  function removeStatus() {
    status.classList.add('hidden', 'text-red-600', 'text-gray-500');
  }

  function addResult(label: string, value: string) {
    const dt = document.createElement('dt');
    dt.className = 'text-gray-500';
    dt.textContent = label;
    const dd = document.createElement('dd');
    dd.className = 'font-medium';
    dd.textContent = value;
    resultsList.append(dt, dd);
  }

  async function scoreFile(contents: string){
    showStatus('Scoring flight…');

    const result = await score(contents);


    if (!result){
      showStatus('Error scoring file.');
      return;
    }

    // Check flight age
    const firstFix = result.flight.fixes[0];
    const flightDate = new Date(firstFix.timestamp);
    const daysSince = (Date.now() - flightDate.getTime()) / (1000 * 60 * 60 * 24);
    const tooOld = daysSince > 7;

    // Display results
    resultsList.innerHTML = '';
    addResult('Hiking Distance', result.groundDist?.toFixed(2) + ' km');
    addResult('Triangle Perimeter', result.best.scoreInfo?.distance?.toFixed(2) + ' km');
    addResult('Closing Distance', result.best.scoreInfo?.penalty.toFixed(2) + ' km');
    let type = result.closed ? "Closed " : "Open "
    type += result.best.opt?.scoring.code.toUpperCase(); 
    addResult('Type', type ?? '—');
    addResult('Score', result.score.toFixed(2) ?? '—');
    if (result.filteredByTime){
      addResult('', "Filtered By Time");
    }
    if (tooOld) {
      addResult('', `Flight is ${Math.floor(daysSince)} days old — uploads must be within 7 days`);
    }

    results.classList.remove('hidden');
    if (tooOld) {
      uploadSection.style.display = 'none';
    } else {
      uploadSection.style.display = '';
    }
    updateUploadBtn();
    removeStatus();

    // Dispatch event for FlightMap (or any other listener)
    document.dispatchEvent(
      new CustomEvent('igc-score-result', {
        detail: result,
      })
    );
  }

  function handleFile(file: File) {
    if (!file.name.toLowerCase().endsWith('.igc')) {
      showStatus('Please select an .igc file.', true);
      return;
    }
    currentFile = file;
    // Reset upload UI for new file
    updateUploadBtn();
    uploadBtn.textContent = 'Upload Tracklog';
    uploadStatus.classList.add('hidden');

    showStatus('Reading file…');
    const reader = new FileReader();
    reader.onload = () => scoreFile(reader.result as string);
    reader.onerror = () => showStatus('Failed to read file.', true);
    reader.readAsText(file);
  }

  input.addEventListener('change', () => {
    if (input.files?.[0]) handleFile(input.files[0]);
  });

  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-50');
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    if (e.dataTransfer?.files?.[0]) handleFile(e.dataTransfer.files[0]);
  });

  uploadBtn.addEventListener('click', async () => {
    if (!currentFile || !USER_ID_RE.test(userIdInput.value) || !passphraseInput.value) return;

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading…';
    uploadStatus.classList.add('hidden');

    try {
      const form = new FormData();
      form.append('file', currentFile);

      const url = `https://tracklog-upload.norcalhf.workers.dev/upload?user_id=${encodeURIComponent(userIdInput.value)}&passphrase=${encodeURIComponent(passphraseInput.value)}`;
      const res = await fetch(url, { method: 'POST', body: form });

      if (!res.ok) {
        if (res.status === 401) {
          throw new Error('Invalid username or passphrase');
        }
        const text = await res.text();
        throw new Error(text || `Upload failed (${res.status})`);
      }

      uploadBtn.textContent = 'Uploaded';
      uploadStatus.textContent = 'Tracklog uploaded successfully. Scores will post tomorrow.';
      uploadStatus.className = 'text-sm text-green-600';
    } catch (err: any) {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload Tracklog';
      uploadStatus.textContent = `Upload failed: ${err.message}`;
      uploadStatus.className = 'text-sm text-red-600';
    }

    uploadStatus.classList.remove('hidden');
  });
</script>